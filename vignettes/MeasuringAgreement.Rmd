---
title: "Measues of Agreement"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MeasuringAgreement}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(kableExtra)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CPTtools)
```

This vignette will use measures of agreement, in particular, the Fleis-Cohen kappa, and the Goodman-Kruskal lambda to explore the proposed adequacy of a cognitively diagnostic assessment.

# Assessment Design

This assessment is based on an example found in [@Mislevy1995].  It is a test of language arts in which there are four constructs being measured:  _Reading_, _Writing_, _Speaking_ and _Listening_.  Each variable can tale on the possible values `Advanced`, `Intermediate` or `Novice`.

There are four kinds of tasks:

Reading
: Subjects read a short segment of text and then answer a selected response question.

Writing
: An integrated Reading/Writing task where the subject provides a short written response based on an reading passage.

Listening
: Subject listens to a prompt followed by a mulitple choice question where the options are also spoken (as are the instructions).

Speaking
: Subject is requested to respond verbally (response is recorded) after listening to an audio stimulus.  The instructions are written.

## Form Design

There are 5 Reading, 5 Listening, 3 Writing and 3 Speaking questions on a form of the test.  Therefore, the Q Matrix looks like:

```{r Q-matrix for language test, echo=FALSE}
qmat <- matrix(c(rep(c(1,0,0,0),5),
                 rep(c(1,1,0,0),3),
                 rep(c(0,0,0,1),5),
                 rep(c(1,0,1,1),3)),
               16,4,
               byrow=TRUE)
colnames(qmat)<-c("Reading","Writing","Speaking","Listening")
rownames(qmat)<-paste0(c(rep("R",5),rep("W",3),
                         rep("L",5),rep("S",3)),1:16)
kbl(qmat,caption="Q-matrix for 16 item test") |>
  kable_classic(full_width=FALSE)
```

## Simulation Experiment

Assuming that the parameters of the 5 item models are known, it is straightforward to simulate data from the assessment.  This kind of simulation provides information about the adequacy of the data collection for classifying the students.

The simulation procedure is as follows:

1. Generate random proficiency profiles using the proficiency model.

2. Generate random item responses using the item (evidence) models.

3. Score the assessment.  There are two variations:
  
  a. _Modal (MAP) Scores_:  The score assigns a category to each of the four constructs.  (These are the columns named "mode.Reading" and similar.)
  
  b. _Expected (Probability) Scores_:  The score assigns a probability of high, medium or low to each individual.  (These are the columns named "Reading.Novice", "Reading.Intermediate", and "Reading.Advanced".)
  
The simulation study itself can be found in `vingette("SimulationStudies",package="RNetica")`.

The results are saved in this package in the data set `language16`.

```{r}
data(language16)
```

## Building the Confusion Matrix

The simulation data has columns containing the "true" value for the four proficiencies---"Reading", "Writing", "Speaking", and "Listening"---and for values for the estimates---"mode.Reading", "mode.Writing", &c.  The cross-tabulation of a true value and its corresponding estimate is known as a confusion matrix.  This can be built in R using the `table` function.[^2]

[^1]: It is in the `Analysis > Descriptives > Cross Tabluations ...` function in SPSS.

```{r Reading.cm}
Reading.cm <- table(language16[,c("Reading","mode.Reading")])
```
```{r Reading.tab,echo=FALSE}
kbl(Reading.cm, caption="Reading confusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Writing.cm}
Writing.cm <- table(language16[,c("Writing","mode.Writing")])
```
```{r Writing.tab,echo=FALSE}
kbl(Writing.cm, caption="Writing confusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Speaking.cm}
Speaking.cm <- table(language16[,c("Speaking","mode.Speaking")])
```
```{r Speaking.tab,echo=FALSE}
kbl(Speaking.cm, caption="Speaking Confusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Listening.cm}
Listening.cm <- table(language16[,c("Listening","mode.Listening")])
```
```{r Listening.tab,echo=FALSE}
kbl(Listening.cm, caption="Listening Confusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

### The expected Confusion Matrix


```{r Reading5}
kbl(language16[1:5,c("Reading","Reading.Novice",
                     "Reading.Intermediate","Reading.Advanced")],
     caption="Reading data from first five simulees.",
     digits=3) |>
  kable_classic()
```
```{r}
reading5 <- expTable(language16[1:5,],"Reading","Reading")
```
```{r Reading.extab,echo=FALSE}
kbl(reading5, digits=3,
    caption="Expected reading confusion matrix using 5 items.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```


```{r Reading.em}
Reading.em <- expTable(language16,"Reading","Reading")
```
```{r Reading.etab,echo=FALSE}
kbl(Reading.em, digits=3,
    caption="Reading expected onfusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Writing.em}
Writing.em <- expTable(language16,"Writing","Writing")
```
```{r Writing.etab,echo=FALSE}
kbl(Writing.em, digits=3,
    caption="Writing expected onfusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Speaking.em}
Speaking.em <- expTable(language16,"Speaking","Speaking")
```
```{r Speaking.etab,echo=FALSE}
kbl(Speaking.em, digits=3,
    caption="Speaking expected onfusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```

```{r Listening.em}
Listening.em <- expTable(language16,"Listening","Listening")
```
```{r Listening.etab,echo=FALSE}
kbl(Listening.em, digits=3,
    caption="Listening expected onfusion matrix for 16 item test.") |>
  kable_classic(full_width=FALSE) |>
  add_header_above(c(" ","Estimated"=3)) |>
  pack_rows(index=c("Simulated"=3))
```
